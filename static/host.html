<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV Clipboard - Host</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <h1>üìã TV Clipboard (Host)</h1>
        <p class="subtitle">Share text between your devices</p>
        <p class="mode-switch">You are host</p>

        <div id="timer" class="timer">
            ‚è±Ô∏è New QR code in <span id="time-remaining">10:00</span>
        </div>

        <div id="status" class="status disconnected">
            üîå Disconnected
        </div>

        <div class="qr-section">
            <h2>üì± Scan with your phone</h2>
            <div id="qrcode"></div>
            <div class="url-text" id="url-text"></div>
        </div>

        <div id="received-section" class="received-section">
            <h2>üì• Received</h2>
            <div id="received-content" class="received-content"></div>
            <div class="timestamp" id="timestamp"></div>
            <button id="reveal-btn" class="reveal-btn" onclick="toggleReveal()">üëÅÔ∏è Show Content</button>
            <div class="button-group">
                <button class="copy-btn" onclick="copyReceived()">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <script src="/static/js/common.js"></script>
    <script src="/static/js/host.js"></script>
    <script>
        let ws;
        let timerInterval;
        const sessionTimeout = 600;

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function startTimer() {
            let remaining = sessionTimeout;
            const timerEl = document.getElementById('time-remaining');

            timerInterval = setInterval(function() {
                remaining--;
                if (timerEl) {
                    timerEl.textContent = formatTime(remaining);
                }

                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    refreshPage();
                } else if (remaining <= 60) {
                    if (timerEl) {
                        timerEl.style.color = '#ff6b6b';
                        timerEl.style.animation = 'pulse 1s infinite';
                    }
                }
            }, 1000);

            if (timerEl) {
                timerEl.textContent = formatTime(remaining);
            }
        }

        function refreshPage() {
            const timerEl = document.getElementById('timer');
            if (timerEl) {
                timerEl.innerHTML = '‚è±Ô∏è <span style="color: #4CAF50;">Refreshing QR code...</span>';
            }
            setTimeout(function() {
                location.reload();
            }, 2000);
        }

        function connect() {
            const url = getWebSocketURL();

            ws = new WebSocket(url);

            ws.onopen = function() {
                const status = document.getElementById('status');
                status.textContent = 'üñ•Ô∏è Host Mode - Connected';
                status.className = 'status connected';
                console.log('WebSocket connected');

                startTimer();
            };

            ws.onclose = function() {
                const status = document.getElementById('status');
                status.textContent = 'üîå Disconnected';
                status.className = 'status disconnected';
                console.log('WebSocket disconnected');

                setTimeout(connect, 3000);
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };

            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                console.log('Received message:', message);

                if (message.type === 'role') {
                    handleRoleAssignment(message.role);
                } else if (message.type === 'text' && message.content) {
                    showReceivedContent(message.content, message.from);
                }
            };
        }

        function handleRoleAssignment(role) {
            if (role !== 'host') {
                console.warn('Expected host role but got:', role);
            }
            generateQRCode();
        }

        connect();
    </script>
</body>
</html>